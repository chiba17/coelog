<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>coelog</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #fcfdff;
            color: #1e293b;
            user-select: none;
        }
        
        .animate-pulse-slow { animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        @keyframes gentleScale {
            0% { transform: scale(0.96); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-gentle-scale { animation: gentleScale 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        @keyframes slideUpFade {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes simpleFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-simple-fade-in { animation: simpleFadeIn 0.8s ease-out forwards; }
        
        @keyframes zoomInUp {
            0% { opacity: 0; transform: scale(0.92) translateY(15px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .animate-zoom-in-up { animation: zoomInUp 0.45s cubic-bezier(0.2, 0.9, 0.2, 1) forwards; will-change: transform, opacity; }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        .delay-100 { animation-delay: 100ms; }
        .delay-200 { animation-delay: 200ms; }
        .delay-300 { animation-delay: 300ms; }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        .icon-btn-circle {
            width: 44px !important;
            height: 44px !important;
            min-width: 44px !important;
            min-height: 44px !important;
            display: flex !important; 
            align-items: center !important; 
            justify-content: center !important; 
            flex-shrink: 0 !important; 
            border-radius: 9999px !important;
            padding: 0 !important;
        }

        .border-visible { border: 1.5px solid #cbd5e1 !important; }
        .border-visible:focus-within { border-color: #818cf8 !important; }
        .rounded-card { border-radius: 1rem !important; }

        .google-btn {
            background-color: white;
            border: 1px solid #cbd5e1;
            color: #334155;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
        
        .no-callout { -webkit-touch-callout: none; }
        .allow-select { user-select: text; -webkit-user-select: text; }
    </style>
</head>
<body class="antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase Configuration ---
        const getFirebaseConfig = () => {
            if (typeof __firebase_config !== 'undefined') return JSON.parse(__firebase_config);
            return {
                apiKey: "AIzaSyA50AwAS5bqerWQsCJvGVAGF44kxHq3QBw",
                authDomain: "coelog-718ad.firebaseapp.com",
                projectId: "coelog-718ad",
                storageBucket: "coelog-718ad.firebasestorage.app",
                messagingSenderId: "862928608681",
                appId: "1:862928608681:web:21c39e011c888727a838b8"
            };
        };

        const config = getFirebaseConfig();
        if (!firebase.apps.length) firebase.initializeApp(config);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'coelog-718ad';

        const MAX_ANSWER_LENGTH = 140;
        const GRADIENTS = [
            { id: 'purple', name: '藤 - Fuji', class: 'bg-gradient-to-br from-indigo-400 via-purple-400 to-fuchsia-400 text-white' },
            { id: 'sunset', name: '茜 - Akane', class: 'bg-gradient-to-br from-rose-400 via-red-400 to-orange-400 text-white' },
            { id: 'ocean', name: '浅葱 - Asagi', class: 'bg-gradient-to-br from-sky-500 via-blue-500 to-indigo-600 text-white' },
            { id: 'nature', name: '常盤 - Tokiwa', class: 'bg-gradient-to-br from-emerald-500 via-green-600 to-teal-700 text-white' },
            { id: 'midnight', name: '群青 - Gunjo', class: 'bg-gradient-to-br from-indigo-500 via-violet-600 to-purple-700 text-white' },
            { id: 'morning', name: '琥珀 - Kohaku', class: 'bg-gradient-to-br from-amber-400 via-orange-500 to-rose-500 text-white' },
            { id: 'coral', name: '珊瑚 - Coral', class: 'bg-gradient-to-br from-rose-400 via-pink-400 to-red-400 text-white' },
            { id: 'mist', name: '霞 - Kasumi', class: 'bg-gradient-to-br from-slate-400 via-gray-500 to-zinc-600 text-white' },
           { id: 'mocha', name: 'モカ - Mocha', class: 'bg-gradient-to-br from-orange-900 via-amber-900 to-stone-800 text-white' },
            { id: 'turquoise', name: '翡翠 - Hisui', class: 'bg-gradient-to-br from-teal-400 via-cyan-500 to-blue-500 text-white' },
        ];

        const formatDateTime = (ts) => {
            if (!ts) return '';
            const d = ts.toDate ? ts.toDate() : new Date(ts);
            return `${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        };

        const Lucide = ({ name, size = 20, className = "", fill = "none", strokeWidth = 2.5 }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current) {
                    iconRef.current.innerHTML = '';
                    const icon = document.createElement('i');
                    icon.setAttribute('data-lucide', name);
                    icon.setAttribute('width', size);
                    icon.setAttribute('height', size);
                    if (fill !== "none") icon.setAttribute('fill', fill);
                    icon.setAttribute('stroke-width', strokeWidth);
                    iconRef.current.appendChild(icon);
                    lucide.createIcons();
                }
            }, [name, size, fill, strokeWidth]);
            return <span ref={iconRef} className={`inline-flex items-center justify-center shrink-0 aspect-square ${className}`}></span>;
        };

        // --- Long Press Hook ---
        const useLongPress = (callback = () => {}, ms = 800) => {
            const [startLongPress, setStartLongPress] = useState(false);
            useEffect(() => {
                let timerId;
                if (startLongPress) {
                    timerId = setTimeout(callback, ms);
                } else {
                    clearTimeout(timerId);
                }
                return () => clearTimeout(timerId);
            }, [startLongPress]);
            return {
                onMouseDown: () => setStartLongPress(true),
                onMouseUp: () => setStartLongPress(false),
                onMouseLeave: () => setStartLongPress(false),
                onTouchStart: () => setStartLongPress(true),
                onTouchEnd: () => setStartLongPress(false),
            };
        };

        function ConfirmModal({ isOpen, title, message, confirmText, cancelText, onConfirm, onCancel, isDanger = false }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[5000] flex items-center justify-center p-6 animate-in fade-in duration-200">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={onCancel} />
                    <div className="relative bg-white w-full max-w-[320px] rounded-3xl p-8 shadow-2xl space-y-6 animate-in zoom-in-95 duration-200">
                        <div className="flex flex-col items-center text-center space-y-3">
                            <div className={`p-3 rounded-2xl ${isDanger ? 'bg-pink-50 text-pink-500' : 'bg-indigo-50 text-indigo-500'}`}>
                                <Lucide name="alert-circle" size={24} />
                            </div>
                            <h3 className="font-black text-lg text-slate-900">{title}</h3>
                            <p className="text-sm text-slate-500 font-bold leading-relaxed">{message}</p>
                        </div>
                        <div className="flex flex-col gap-2">
                            <button onClick={onConfirm} className={`w-full py-3.5 rounded-2xl font-black text-sm transition-all active:scale-95 ${isDanger ? 'bg-pink-500 text-white shadow-lg' : 'bg-indigo-500 text-white shadow-lg'}`}>{confirmText}</button>
                            <button onClick={onCancel} className="w-full py-3.5 rounded-2xl font-black text-sm text-slate-400">{cancelText}</button>
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('loading'); 
            const [surveys, setSurveys] = useState([]);
            const [responses, setResponses] = useState([]);
            const [currentSurvey, setCurrentSurvey] = useState(null);
            const [selectedResponseIndex, setSelectedResponseIndex] = useState(0);
            const [notification, setNotification] = useState(null);
            const [isPreviewMode, setIsPreviewMode] = useState(false);
            const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const initAuth = async () => {
                    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    const params = new URLSearchParams(window.location.search);
                    const surveyId = params.get('id');

                    auth.onAuthStateChanged(async (u) => {
                        if (u) {
                            setUser(u);
                            if (surveyId) {
                                try {
                                    const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('surveys').doc(surveyId).get();
                                    if (doc.exists) {
                                        setCurrentSurvey({ id: doc.id, ...doc.data() });
                                        setView('respond');
                                    } else {
                                        setView('home'); 
                                    }
                                } catch(e) { console.error(e); setView('home'); }
                            } else {
                                setView('home'); 
                            }
                        } else {
                            if (surveyId) {
                                await auth.signInAnonymously();
                            } else {
                                setView('login'); 
                            }
                        }
                        setLoading(false);
                    });
                };
                initAuth();
            }, []);

            useEffect(() => {
                if (!user) return;
                const path = db.collection('artifacts').doc(appId).collection('public').doc('data');
                const unsubSurveys = path.collection('surveys').onSnapshot(snap => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setSurveys(data.filter(s => s.creatorId === user.uid).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
                }, e => console.error("Survey Fetch Error:", e));
                const unsubResponses = path.collection('responses').onSnapshot(snap => {
                    setResponses(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                }, e => console.error("Response Fetch Error:", e));
                return () => { unsubSurveys(); unsubResponses(); };
            }, [user, appId]);

            const showToast = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 3500); };

            const handleLoginGoogle = async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await auth.signInWithPopup(provider);
                    showToast("ログインしました");
                    setView('home');
                } catch (e) {
                    console.error(e);
                    if (e.code === 'auth/unauthorized-domain') {
                        alert("エラー: 許可されていないドメインです。Firebase Consoleで設定を確認してください。");
                    } else {
                        showToast("ログイン失敗");
                    }
                }
            };

            const handleLogout = async () => {
                await auth.signOut();
                setShowLogoutConfirm(false);
                setView('login');
                showToast("ログアウトしました");
            };

            const handleCopyURL = () => {
                if (!currentSurvey) return;
                const url = window.location.origin + window.location.pathname + "?id=" + currentSurvey.id;
                const textArea = document.createElement("textarea");
                textArea.value = url;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus({preventScroll: true});
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast("回答用URLをコピーしました");
                } catch (err) {
                    showToast("コピー失敗しました");
                }
                document.body.removeChild(textArea);
            };

            const handleSaveSurvey = async (surveyData) => {
                if (!user) return;
                try {
                    const { id, ...data } = surveyData;
                    const cleanData = {};
                    Object.keys(data).forEach(key => { if(data[key] !== undefined) cleanData[key] = data[key]; });
                    const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('surveys');
                    if (id) {
                        await ref.doc(id).update(cleanData);
                        showToast("更新しました");
                        setCurrentSurvey({ id, ...cleanData });
                        setView('stats');
                    } else {
                        await ref.add({ ...cleanData, creatorId: user.uid, createdAt: firebase.firestore.Timestamp.now() });
                        showToast("作成しました");
                        setView('home');
                    }
                } catch (e) {
                    showToast("保存エラー: " + e.message);
                }
            };

            const handleAddResponse = async (answer, allowSns) => {
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').add({
                        surveyId: currentSurvey.id, answer, allowSns, liked: false, createdAt: firebase.firestore.Timestamp.now()
                    });
                    showToast("届けました");
                } catch (e) { showToast("送信失敗"); }
            };

            const toggleLike = async (id) => {
                const res = responses.find(r => r.id === id);
                if (!res) return;
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').doc(id).update({ liked: !res.liked });
                showToast(!res.liked ? "お気に入りに追加" : "お気に入り解除");
            };

            const handleDeleteSurvey = async (id) => {
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('surveys').doc(id).delete();
                    showToast("削除しました");
                    setView('home');
                } catch (e) { showToast("削除失敗"); }
            };

            const handleDeleteResponse = async (id) => {
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').doc(id).delete();
                    showToast("回答を削除しました");
                } catch (e) { showToast("削除失敗"); }
            };

            const currentResponses = useMemo(() => responses.filter(r => r.surveyId === currentSurvey?.id).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)), [responses, currentSurvey]);
            
            const favoriteResponses = useMemo(() => {
                return responses.filter(r => r.liked && surveys.some(s => s.id === r.surveyId));
            }, [responses, surveys]);

            const navigate = (v, d = null, i = 0, isPreview = false) => {
                setIsPreviewMode(isPreview);
                if(d) setCurrentSurvey(d);
                if(v === 'share') setSelectedResponseIndex(i);
                setView(v);
                window.scrollTo(0,0);
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center font-black text-indigo-400 animate-pulse">coelog...</div>;

            return (
                <div className="max-w-md mx-auto px-5 py-6 relative min-h-screen overflow-hidden">
                    {view === 'login' && <LoginView onLoginGoogle={handleLoginGoogle} />}
                    {view === 'home' && <HomeView surveys={surveys} user={user} onLogoutRequest={() => setShowLogoutConfirm(true)} onNavigate={navigate} />}
                    {view === 'favorites' && <FavoritesView responses={favoriteResponses} surveys={surveys} onNavigate={navigate} onBack={() => setView('home')} onToggleLike={toggleLike} />}
                    {(view === 'create' || view === 'edit') && <SurveyFormView initialData={view === 'edit' ? currentSurvey : null} onSave={handleSaveSurvey} onBack={() => setView(view === 'edit' ? 'stats' : 'home')} />}
                    {view === 'respond' && <RespondView survey={currentSurvey} onSubmit={handleAddResponse} onBack={() => setView('stats')} isPreview={isPreviewMode} />}
                    {view === 'stats' && <StatsView survey={currentSurvey} responses={currentResponses} onNavigate={(v, d, i, p) => navigate(v, d, i, p)} onBack={() => setView('home')} onDelete={handleDeleteSurvey} onDeleteResponse={handleDeleteResponse} onToggleLike={toggleLike} onCopy={handleCopyURL} />}
                    {view === 'share' && <ResponseGallery responses={currentSurvey ? currentResponses : favoriteResponses} initialIndex={selectedResponseIndex} survey={currentSurvey} surveys={surveys} onClose={() => setView(currentSurvey ? 'stats' : 'favorites')} />}

                    {notification && (
                        <div className="fixed top-6 left-1/2 -translate-x-1/2 z-[3000] animate-in fade-in slide-in-from-top-2">
                            <div className="bg-slate-900/95 backdrop-blur-md text-white px-5 py-2.5 rounded-2xl text-xs font-bold shadow-xl flex items-center gap-2 border border-white/10">
                                <Lucide name="check-circle-2" size={14} className="text-emerald-400" />
                                {notification}
                            </div>
                        </div>
                    )}

                    <ConfirmModal 
                        isOpen={showLogoutConfirm} 
                        title="ログアウト" 
                        message="ログアウトしますか？" 
                        confirmText="ログアウト" 
                        cancelText="キャンセル" 
                        isDanger={true}
                        onConfirm={handleLogout} 
                        onCancel={() => setShowLogoutConfirm(false)} 
                    />

                    {['home', 'stats', 'favorites'].includes(view) && (
                        <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-auto bg-white/95 border border-slate-300 shadow-[0_15px_40px_rgba(0,0,0,0.08)] rounded-full flex items-center p-2 z-[100]">
                            <button onClick={() => navigate('home')} className={`icon-btn-circle transition-all ${view === 'home' ? 'bg-indigo-50 text-white shadow-md' : 'text-slate-400'}`}>
                                <Lucide name="layout" size={20} />
                            </button>
                            <div className="w-4 shrink-0" />
                            <button onClick={() => navigate('create')} className={`icon-btn-circle transition-all ${view === 'create' ? 'bg-indigo-500 text-white shadow-md' : 'text-slate-400'}`}>
                                <Lucide name="plus" size={20} />
                            </button>
                            <div className="w-4 shrink-0" />
                            <button onClick={() => navigate('favorites')} className={`icon-btn-circle transition-all ${view === 'favorites' ? 'bg-indigo-500 text-white shadow-md' : 'text-slate-400'}`}>
                                <Lucide name="heart" size={20} fill={view === 'favorites' ? "currentColor" : "none"} />
                            </button>
                        </nav>
                    )}
                </div>
            );
        }

        // --- Sub-View Components ---

        function LoginView({ onLoginGoogle }) {
            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 space-y-10 animate-in fade-in duration-700">
                    <div className="text-center space-y-4">
                        <div className="w-20 h-20 rounded-[2rem] bg-gradient-to-tr from-indigo-500 to-purple-400 flex items-center justify-center text-white shadow-2xl mx-auto mb-6 animate-pulse-slow">
                            <Lucide name="sparkles" size={40} />
                        </div>
                        <h1 className="text-4xl font-black tracking-tighter text-slate-900">coelog</h1>
                    </div>
                    
                    <div className="w-full max-w-xs space-y-4">
                        <button onClick={onLoginGoogle} className="google-btn w-full justify-center py-4 text-base active:scale-95 transition-all">
                            <Lucide name="mail" size={20} />
                            Googleで始める
                        </button>
                    </div>
                </div>
            );
        }

        function HomeView({ surveys, user, onLogoutRequest, onNavigate }) {
            return (
                <div className="space-y-6 animate-in fade-in duration-500">
                    <header className="flex items-center justify-between py-1 px-1">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 rounded-xl bg-gradient-to-tr from-indigo-500 to-purple-400 flex items-center justify-center text-white shadow-md animate-pulse-slow shrink-0"><Lucide name="sparkles" size={14} /></div>
                            <h1 className="text-xl font-black tracking-tighter text-slate-900">coelog</h1>
                        </div>
                        <button onClick={onLogoutRequest} className="icon-btn-circle text-slate-400 bg-white shadow-sm border-visible active:scale-90 transition-all">
                             <Lucide name="log-out" size={18} />
                        </button>
                    </header>
                    <div className="grid gap-4 pb-24">
                        {surveys.length === 0 ? (
                            <button onClick={() => onNavigate('create')} className="w-full bg-white border-2 border-dashed border-slate-300 rounded-card py-12 text-center space-y-3"><Lucide name="plus" size={24} className="mx-auto text-indigo-200" /><p className="text-slate-500 text-xs font-bold">アンケートを作成</p></button>
                        ) : surveys.map(s => (
                            <button key={s.id} onClick={() => onNavigate('stats', s)} className="bg-white border-visible p-4 rounded-card text-left shadow-sm hover:shadow-md transition-all active:scale-[0.98]">
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center text-slate-400 font-black text-[9px]"><div className="p-1.5 bg-indigo-50 text-indigo-500 rounded-xl"><Lucide name="message-circle" size={14} /></div><span className="flex items-center gap-1"><Lucide name="clock" size={10} /> {formatDateTime(s.createdAt)}</span></div>
                                    <div><h3 className="font-bold text-lg text-slate-800 leading-tight">{s.title}</h3><p className="text-xs text-slate-400 line-clamp-1 italic mt-1">"{s.question}"</p></div>
                                </div>
                            </button>
                        ))}
                    </div>
                </div>
            );
        }

        function FavoritesView({ responses, surveys, onNavigate, onBack, onToggleLike }) {
            return (
                <div className="space-y-6 animate-in fade-in duration-500">
                    <header className="flex flex-col py-1 px-1"><h1 className="text-2xl font-black text-slate-900">お気に入り</h1><p className="text-slate-400 text-xs font-bold">心に残った大切な声</p></header>
                    <div className="grid gap-3 pb-24">
                        {responses.length === 0 ? <div className="bg-white/40 border-2 border-dashed border-slate-300 rounded-card py-16 text-center text-slate-300 text-xs font-bold italic">まだありません</div> : responses.map((res, i) => {
                            const s = surveys.find(sur => sur.id === res.surveyId);
                            return (
                                <div key={res.id} onClick={() => onNavigate('share', null, i)} className="bg-white border-visible p-4 rounded-card flex flex-col gap-3 shadow-sm hover:shadow-md transition-all cursor-pointer active:scale-[0.99] select-none no-callout animate-simple-fade-in" style={{ animationDelay: `${i * 100}ms`, animationFillMode: 'forwards' }}>
                                    <div className="flex items-center justify-between">
                                        <div className="flex flex-col gap-1 w-full pr-2">
                                            <span className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">{s?.title || "テーマ不明"}</span>
                                            <span className="text-[10px] font-bold text-slate-400">{formatDateTime(res.createdAt)}</span>
                                        </div>
                                        <button onClick={e => { e.stopPropagation(); onToggleLike(res.id); }} className="icon-btn-circle bg-pink-50 text-pink-500 shrink-0"><Lucide name="heart" size={18} fill="currentColor" /></button>
                                    </div>
                                    <p className="font-bold text-slate-800 italic text-sm leading-relaxed break-words line-clamp-3">"{res.answer}"</p>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        function SurveyFormView({ initialData, onSave, onBack }) {
            const [title, setTitle] = useState(initialData?.title || '');
            const [question, setQuestion] = useState(initialData?.question || '');
            const [gradientId, setGradientId] = useState(initialData?.gradientId || 'purple');
            const [showConfirm, setShowConfirm] = useState(false);
            const isEdit = !!initialData;
            
            const hasChanges = useMemo(() => {
                const initialTitle = initialData?.title || '';
                const initialQuestion = initialData?.question || '';
                const initialGradient = initialData?.gradientId || 'purple';
                return title !== initialTitle || question !== initialQuestion || gradientId !== initialGradient;
            }, [title, question, gradientId, initialData]);

            const handleBack = () => {
                if (hasChanges) setShowConfirm(true);
                else onBack();
            };

            return (
                <div className="space-y-4 animate-in slide-in-from-right-4 duration-400 pb-20">
                    <header className="flex items-center justify-between py-1">
                        <button onClick={handleBack} className="icon-btn-circle text-slate-500 bg-white shadow-sm border-visible active:scale-90 transition-all"><Lucide name="arrow-left" size={18} /></button>
                        <h2 className="font-black text-sm text-slate-900">{isEdit ? '内容を編集' : '新しく作る'}</h2><div className="w-11 h-11 shrink-0" />
                    </header>
                    <div className="bg-white border border-slate-200 rounded-[2.2rem] p-6 shadow-sm space-y-5">
                        <div className="space-y-1.2"><label className="text-[10px] font-black text-indigo-500 uppercase tracking-widest ml-1">アンケート名</label><input type="text" placeholder="例：次回のテーマについて" className="w-full bg-transparent border-b-2 border-slate-200 focus:border-indigo-400 outline-none py-1.5 text-xl font-bold transition-all placeholder:text-slate-300" value={title} onChange={e => setTitle(e.target.value)} /></div>
                        <div className="space-y-2"><label className="text-[10px] font-black text-indigo-500 uppercase tracking-widest ml-1">質問の内容</label><textarea placeholder="聞きたいことをひとつだけ" className="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 text-sm font-bold focus:bg-white focus:border-indigo-400 outline-none transition-all resize-none h-32" value={question} onChange={e => setQuestion(e.target.value)} /></div>
                        <div className="space-y-3"><label className="text-[10px] font-black text-indigo-500 uppercase tracking-widest ml-1">デザイン</label><div className="flex flex-wrap gap-3 px-1">{GRADIENTS.map(g => (
                            <button key={g.id} onClick={() => setGradientId(g.id)} className={`w-9 h-9 rounded-full transition-all relative ${g.class} ${gradientId === g.id ? 'scale-110 ring-4 ring-indigo-50 shadow-md' : 'hover:scale-105'}`}>
                                {gradientId === g.id && <Lucide name="check" size={14} className="text-white mx-auto drop-shadow-md" />}
                            </button>
                        ))}</div></div>
                    </div>
                    <div className="flex flex-col items-center gap-4 pt-4">
                        <button onClick={() => onSave({ id: initialData?.id, title, question, gradientId })} disabled={!title || !question} className={`px-12 py-4 h-14 rounded-full font-black text-lg text-white shadow-xl flex items-center justify-center gap-3 active:scale-95 transition-all ${!title || !question ? 'bg-slate-300 shadow-none' : 'bg-gradient-to-r from-indigo-500 to-purple-500 shadow-xl shadow-indigo-100'}`}>
                            {isEdit ? '変更を保存する' : 'アンケートを公開'} <Lucide name="send" size={20} />
                        </button>
                    </div>
                    <ConfirmModal isOpen={showConfirm} title="確認" message="入力した内容は保存されませんが、よろしいですか？" confirmText="破棄して戻る" cancelText="続ける" onConfirm={onBack} onCancel={() => setShowConfirm(false)} />
                </div>
            );
        }

        const ResponseItem = ({ res, survey, index, length, onNavigate, onToggleLike, setDeleteResId }) => {
            const longPressProps = useLongPress(() => setDeleteResId(res.id), 800);
            return (
                <div 
                    onClick={() => onNavigate('share', survey, index)}
                    {...longPressProps}
                    onContextMenu={(e) => { e.preventDefault(); setDeleteResId(res.id); }}
                    className={`bg-white border-visible p-4 rounded-card flex flex-col gap-3 shadow-sm hover:shadow-md transition-all cursor-pointer active:scale-[0.99] select-none no-callout animate-simple-fade-in opacity-0 ${res.allowSns ? 'border-slate-300' : 'border-pink-200'}`}
                    style={{ animationDelay: `${index * 50}ms`, animationFillMode: 'forwards' }}
                >
                    <div className="flex items-start justify-between pointer-events-none">
                        <div className="flex flex-col gap-1.5 w-full pr-2">
                            <div className="flex items-center gap-2">
                                <div className={`w-6 h-6 rounded-lg flex items-center justify-center font-black text-[9px] shrink-0 ${res.allowSns ? 'bg-indigo-50 text-indigo-500' : 'bg-pink-50 text-pink-500'}`}>{res.allowSns ? `#${length - index}` : <Lucide name="lock" size={10} />}</div>
                                <div className="text-[10px] text-slate-500 font-bold">{formatDateTime(res.createdAt)}</div>
                                {!res.allowSns && <span className="text-[8px] font-black text-pink-400 uppercase tracking-tighter shrink-0 border border-pink-100 px-1.5 py-0.5 rounded-full">SNS不可</span>}
                            </div>
                        </div>
                        <button onClick={e => { e.stopPropagation(); onToggleLike(res.id); }} className={`pointer-events-auto w-8 h-8 flex items-center justify-center rounded-xl transition-all shrink-0 ${res.liked ? 'bg-pink-50 text-pink-500' : 'text-slate-300 hover:bg-slate-50'}`}><Lucide name="heart" size={18} fill={res.liked ? "currentColor" : "none"} /></button>
                    </div>
                    <p className="font-bold text-slate-800 italic text-sm leading-relaxed break-words line-clamp-3 pointer-events-none">"{res.answer}"</p>
                </div>
            );
        };

        function StatsView({ survey, responses, onNavigate, onBack, onDelete, onDeleteResponse, onToggleLike, onCopy }) {
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [deleteResId, setDeleteResId] = useState(null);
            
            const theme = GRADIENTS.find(g => g.id === survey?.gradientId) || GRADIENTS[0];
            
            return (
                <div className="space-y-6 animate-in slide-in-from-right-4 duration-400 pb-24">
                    <header className="flex items-center justify-between py-1"><button onClick={onBack} className="icon-btn-circle text-slate-500 bg-white shadow-sm border-visible active:scale-90 transition-all"><Lucide name="arrow-left" size={18} /></button><h2 className="font-black text-slate-900 line-clamp-1 text-sm text-center flex-1 px-4">{survey.title}</h2><button onClick={() => onNavigate('edit', survey)} className="icon-btn-circle text-slate-500 bg-white shadow-sm border-visible active:scale-90 transition-all"><Lucide name="edit-3" size={18} /></button></header>
                    <div className={`${theme.class} rounded-3xl py-4 px-8 text-white shadow-xl relative text-center space-y-4 overflow-hidden animate-simple-fade-in`}><div className="space-y-0.5"><span className="text-white/80 text-[10px] font-black uppercase tracking-widest">回答数</span><div className="text-6xl font-black tracking-tighter tabular-nums">{responses.length}</div></div><div className="grid grid-cols-2 gap-2.5 pt-1"><button onClick={onCopy} className="flex items-center justify-center gap-1.5 bg-white/20 backdrop-blur-md border border-white/30 py-2.5 rounded-xl text-[11px] font-black active:scale-95 transition-all"><Lucide name="copy" size={14} /> URLコピー</button>
                    <button onClick={() => onNavigate('respond', survey, 0, true)} className="flex items-center justify-center gap-1.5 bg-white text-indigo-600 py-2.5 rounded-xl text-[11px] font-black shadow-lg active:scale-95 transition-all"><Lucide name="eye" size={14} /> プレビュー</button></div></div>
                    <section className="space-y-4"><div className="flex justify-between items-center px-2 text-[10px] font-black text-slate-500 uppercase tracking-widest"><h3>最近の回答</h3><button onClick={() => setShowDeleteConfirm(true)} className="text-pink-500 flex items-center gap-1"><Lucide name="trash-2" size={11} /> 削除</button></div>
                        <div className="grid gap-3">{responses.length === 0 ? <div className="bg-white border-visible border-dashed rounded-card py-12 text-center italic text-xs text-slate-400">まだ回答はありません</div> : responses.map((res, i) => (
                            <ResponseItem 
                                key={res.id} 
                                res={res} 
                                survey={survey} 
                                index={i} 
                                length={responses.length} 
                                onNavigate={onNavigate} 
                                onToggleLike={onToggleLike} 
                                setDeleteResId={setDeleteResId} 
                            />
                        ))}</div>
                    </section>
                    <ConfirmModal isOpen={showDeleteConfirm} title="アンケートの削除" message="アンケートとすべての回答が完全に削除されます。よろしいですか？" confirmText="削除する" cancelText="キャンセル" isDanger={true} onConfirm={() => { setShowDeleteConfirm(false); onDelete(survey.id); }} onCancel={() => setShowDeleteConfirm(false)} />
                    <ConfirmModal isOpen={!!deleteResId} title="回答の削除" message="この回答を削除しますか？" confirmText="削除する" cancelText="キャンセル" isDanger={true} onConfirm={() => { onDeleteResponse(deleteResId); setDeleteResId(null); }} onCancel={() => setDeleteResId(null)} />
                </div>
            );
        }

        function RespondView({ survey, onSubmit, onBack, isPreview }) {
            const [answer, setAnswer] = useState('');
            const [allowSns, setAllowSns] = useState(true);
            const [submitted, setSubmitted] = useState(false);
            const handleSubmitClick = async () => {
                if (!answer) return;
                await onSubmit(answer, allowSns);
                setSubmitted(true);
            };
            
            const handleCloseWindow = () => {
                window.close();
                alert("回答ありがとうございました。ブラウザを閉じて終了してください。");
            };

            const theme = GRADIENTS.find(g => g.id === survey?.gradientId) || GRADIENTS[0];

            if (submitted) return (
                <div className={`fixed inset-0 z-50 ${theme.class} flex flex-col items-center justify-center p-6 animate-in zoom-in-95 duration-500`}>
                    <div className="bg-white/10 backdrop-blur-xl border border-white/20 rounded-[2.5rem] p-10 shadow-2xl w-full max-w-sm text-center animate-gentle-scale">
                        <div className="w-20 h-20 bg-white text-indigo-500 rounded-full flex items-center justify-center shadow-lg mb-6 mx-auto animate-float"><Lucide name="check" size={36} strokeWidth={4} /></div>
                        <h2 className="text-2xl font-black text-white tracking-tight mb-2 drop-shadow-md animate-simple-fade-in delay-100" style={{animationFillMode:'both'}}>Thank You!</h2>
                        <p className="text-white/80 text-sm font-bold leading-relaxed mb-10 animate-simple-fade-in delay-200" style={{animationFillMode:'both'}}>回答ありがとうございました。</p>
                        {isPreview ? 
                            <button onClick={onBack} className="w-full bg-white text-indigo-600 py-4 rounded-full font-black text-sm shadow-xl active:scale-95 transition-all hover:shadow-2xl animate-simple-fade-in delay-300" style={{animationFillMode:'both'}}>回答一覧に戻る</button> : 
                            <button onClick={handleCloseWindow} className="w-full bg-white/20 text-white border border-white/40 py-4 rounded-full font-black text-sm hover:bg-white/30 transition-all active:scale-95 animate-simple-fade-in delay-300" style={{animationFillMode:'both'}}>ブラウザを閉じて終了</button>
                        }
                    </div>
                </div>
            );

            return (
                <div className={`fixed inset-0 z-50 ${theme.class} flex flex-col items-center justify-center p-4 animate-in fade-in duration-500`}>
                    <div className="relative w-full max-w-md bg-white/10 backdrop-blur-xl border border-white/20 rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-full" style={{ maxHeight: '90vh' }}>
                        <header className="flex items-center justify-center relative p-4 border-b border-white/10 shrink-0">
                            {isPreview && <button onClick={onBack} className="absolute left-4 icon-btn-circle text-white bg-white/20 hover:bg-white/30 transition-all z-20"><Lucide name="arrow-left" size={20} /></button>}
                            <h1 className="text-sm font-black text-white tracking-wider uppercase opacity-80 truncate px-12">{survey.title}</h1>
                        </header>

                        <div className="overflow-y-auto p-6 flex flex-col items-center custom-scrollbar w-full">
                            <div className="text-center w-full mb-8">
                                <p className="text-xl font-black text-white leading-snug italic drop-shadow-md">{survey.question}</p>
                            </div>

                            <div className="w-full relative mb-6">
                                <textarea 
                                    placeholder="ここに答えを書いてください..." 
                                    className="w-full bg-black/10 border border-white/10 rounded-2xl p-4 text-white placeholder:text-white/30 font-bold focus:bg-black/20 focus:border-white/30 outline-none transition-all resize-none h-48 allow-select" 
                                    value={answer} 
                                    maxLength={MAX_ANSWER_LENGTH}
                                    onChange={(e) => setAnswer(e.target.value)} 
                                />
                                <div className={`text-right mt-2 text-[10px] font-black tracking-widest ${answer.length >= MAX_ANSWER_LENGTH ? 'text-pink-300' : 'text-white/50'}`}>{answer.length} / {MAX_ANSWER_LENGTH}</div>
                            </div>

                            <div className="w-full space-y-4">
                                <button onClick={() => setAllowSns(!allowSns)} className="w-full flex items-center justify-center gap-2 py-2 select-none group">
                                    <div className={`w-5 h-5 rounded-lg border-2 flex items-center justify-center transition-all shrink-0 ${allowSns ? 'bg-white border-white' : 'border-white/40'}`}>{allowSns && <Lucide name="check" size={14} className="text-indigo-500 stroke-[4px]" />}</div>
                                    <span className={`text-[11px] font-bold transition-colors ${allowSns ? 'text-white' : 'text-white/60'}`}>SNS等への掲載を許可する</span>
                                </button>
                                <button onClick={handleSubmitClick} disabled={!answer} className={`w-full py-4 rounded-full font-black text-base shadow-xl flex items-center justify-center gap-2 transition-all ${!answer ? 'bg-white/20 text-white/40 cursor-not-allowed' : 'bg-white text-indigo-600 hover:scale-[1.02] active:scale-95'}`}>想いを届ける <Lucide name="send" size={18} /></button>
                            </div>

                            <div className="mt-6 flex justify-center">
                                <div className="inline-flex items-center gap-1.5 bg-black/20 px-3 py-1 rounded-full border border-white/10">
                                    <Lucide name="shield-check" size={10} className="text-white/70" />
                                    <p className="text-[9px] font-bold text-white/70">回答は匿名です</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function ResponseGallery({ responses, initialIndex, survey, surveys, onClose }) {
            const [index, setIndex] = useState(initialIndex);
            const response = responses[index];
            if (!response) return null;
            const activeSurvey = survey || surveys.find(s => s.id === response.surveyId);
            const theme = GRADIENTS.find(g => g.id === activeSurvey?.gradientId) || GRADIENTS[0];
            const getFontSize = (text) => text.length < 20 ? 'text-4xl' : text.length < 40 ? 'text-3xl' : text.length < 80 ? 'text-2xl' : 'text-xl';
            
            // タップ遷移ロジック
            const handleTap = () => {
                if (index < responses.length - 1) {
                    setIndex(index + 1);
                } else {
                    onClose();
                }
            };

            return (
                <div onClick={handleTap} className={`fixed inset-0 z-[100] ${theme.class} flex flex-col h-full w-full animate-in fade-in duration-300 cursor-pointer`}>
                    <div className="absolute top-0 left-0 w-full p-4 pt-safe z-20 flex justify-end items-center pointer-events-none">
                        <button onClick={(e) => { e.stopPropagation(); onClose(); }} className="pointer-events-auto w-10 h-10 flex items-center justify-center rounded-full text-white/30 hover:text-white/80 transition-colors"><Lucide name="x" size={24} /></button>
                    </div>
                    <div className="flex-1 flex flex-col items-center justify-center p-6 min-h-0 relative">
                        <div className="absolute -top-20 -left-20 w-[300px] h-[300px] bg-white/20 rounded-full blur-[80px]" /><div className="absolute bottom-0 right-0 w-[200px] h-[200px] bg-white/10 rounded-full blur-[60px]" />
                        <div className="w-full max-w-sm bg-white/10 backdrop-blur-xl border border-white/20 rounded-3xl shadow-2xl relative flex flex-col overflow-hidden shrink-0 z-10" style={{ maxHeight: '75vh' }}>
                            <div className="relative z-10 flex flex-col h-full overflow-hidden">
                                <div className="p-6 pb-0 shrink-0 text-center">
                                    <div className="text-white/70 text-[10px] font-black uppercase tracking-[0.2em] mb-2 flex items-center justify-center gap-2"><span className="w-6 h-[1px] bg-white/40 shrink-0" /> 質問のテーマ</div>
                                    <h1 className="text-white text-xl font-black leading-tight drop-shadow-md mb-2">{activeSurvey?.title || "お気に入り"}</h1>
                                </div>
                                <div className="flex-1 flex flex-col justify-center items-center p-6 overflow-hidden relative">
                                    <div className="w-full border-b border-white/20 pb-4 mb-6">{activeSurvey && <div className="text-white/90 text-sm font-bold leading-relaxed text-center">{activeSurvey.question}</div>}</div>
                                    <div className={`w-full text-center text-white font-bold italic drop-shadow-md break-words ${getFontSize(response.answer)}`}>{response.answer}</div>
                                    {!response.allowSns && <div className="absolute bottom-2 right-2 inline-flex items-center gap-1.5 px-2.5 py-1 bg-pink-500/50 rounded-full border border-white/20 text-[9px] font-black text-white uppercase tracking-widest shadow-lg"><Lucide name="lock" size={10} /> SNS不可</div>}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>